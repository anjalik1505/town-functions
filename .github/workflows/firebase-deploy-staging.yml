name: Firebase Staging Deploy

on:
  push:
    branches:
      - main
    paths:
      - "functions/**"
      - "web/**"
      - ".firebaserc"
      - ".firebase.json"
      - ".github/**"
      - "firestore.rules"
      - "firestore.indexes.json"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Check for Functions Changes
        id: functions-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            functions/**
            .github/**

      - name: Check for Web Changes
        id: web-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            web/**
            .github/**

      - name: Check for Firestore Changes
        id: firestore-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            firestore.rules
            firestore.indexes.json
            .firebaserc
            .firebase.json
            .github/**

      - name: Check for Storage Changes
        id: storage-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            storage.rules
            .firebaserc
            .firebase.json
            .github/**

      - name: Build Functions
        if: steps.functions-changes.outputs.any_changed == 'true'
        run: |
          cd functions
          npm install
          npm run build
          cd ..

      - name: Deploy Functions
        if: steps.functions-changes.outputs.any_changed == 'true'
        uses: w9jds/firebase-action@v14.0.1
        with:
          args: deploy --only functions
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_STAGING }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}

      - name: Deploy Web
        if: steps.web-changes.outputs.any_changed == 'true'
        uses: w9jds/firebase-action@v14.0.1
        with:
          args: deploy --only hosting
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_STAGING }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}

      - name: Deploy Firestore
        if: steps.firestore-changes.outputs.any_changed == 'true'
        uses: w9jds/firebase-action@v14.0.1
        with:
          args: deploy --only firestore
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_STAGING }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}

      - name: Deploy Storage
        if: steps.storage-changes.outputs.any_changed == 'true'
        uses: w9jds/firebase-action@v14.0.1
        with:
          args: deploy --only storage
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_STAGING }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}
